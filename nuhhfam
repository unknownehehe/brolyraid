--------- FULL MERGED UI + BROLY + AUTOQUEST SCRIPT ---------

-- === WHITELIST SYSTEM ===
local whitelist = {
    ["BowDown9II"] = true,       -- add Roblox username here
    ["NOtThatOnEALT5"] = true,
    ["PokeMaBall"] = true,
}

local Players = game:GetService("Players")
local player = Players.LocalPlayer
if not whitelist[player.Name] then
    warn("nigga u ain whitelisted")
    return  -- stops the entire script for anyone not whitelisted
end

-- CLEANUP
pcall(function() game.CoreGui.BroccoliFarmUI:Destroy() end)

-- === GUI SETUP (JoinNotify style) ===
local gui = Instance.new("ScreenGui")
gui.Name = "BroccoliFarmUI"
gui.Parent = game.CoreGui
gui.ResetOnSpawn = false

local frame = Instance.new("Frame", gui)
frame.Position = UDim2.new(0, 20, 0.65, 0)
frame.BackgroundColor3 = Color3.fromRGB(20,20,20)
frame.BorderSizePixel = 0
frame.Active = true
frame.Draggable = true
frame.ClipsDescendants = true
Instance.new("UICorner", frame).CornerRadius = UDim.new(0,14)

-- Title
local title = Instance.new("TextLabel", frame)
title.Size = UDim2.new(1, 0, 0, 30)
title.BackgroundTransparency = 1
title.Text = "Broly Raid"
title.TextColor3 = Color3.new(1, 1, 1)
title.Font = Enum.Font.GothamBold
title.TextSize = 16

-- Status
local statusLabel = Instance.new("TextLabel", frame)
statusLabel.Size = UDim2.new(1,-20,0,25)
statusLabel.Position = UDim2.new(0,10,0,35)
statusLabel.Text = "Status: All OFF"
statusLabel.Font = Enum.Font.Gotham
statusLabel.TextSize = 14
statusLabel.TextColor3 = Color3.new(1,1,1)
statusLabel.BackgroundTransparency = 1

-- BUTTON STORAGE
local buttons = {}
local function createButton(text, yPos)
    local btn = Instance.new("TextButton", frame)
    btn.Size = UDim2.new(0.8,0,0,30)
    btn.Position = UDim2.new(0.1,0,0,yPos)
    btn.Text = text
    btn.Font = Enum.Font.GothamBold
    btn.TextSize = 14
    btn.TextColor3 = Color3.new(1,1,1)
    btn.BackgroundColor3 = Color3.fromRGB(40,40,40)
    btn.BorderSizePixel = 0
    Instance.new("UICorner", btn).CornerRadius = UDim.new(0,10)
    table.insert(buttons, btn)
    return btn
end

-- Buttons (positions)
local transformBtn = createButton("Transform: OFF", 65)
local farmBtn      = createButton("Farm Broly Raid: OFF", 105)
local blockBtn     = createButton("Auto Block: OFF", 145)
local chargeBtn    = createButton("Charge: OFF", 185)
local flyBtn       = createButton("Fly: OFF", 225)
local questBtn     = createButton("Quest Grind: OFF", 265) -- NEW toggle button

-- Resize frame automatically
local function resizeFrame()
    frame.Size = UDim2.new(0, 260, 0, 30 + 35 + #buttons * 40)
end
resizeFrame()

-- Minimize button
local miniBtn = Instance.new("TextButton", frame)
miniBtn.Size = UDim2.new(0,24,0,24)
miniBtn.Position = UDim2.new(1,-28,0,3)
miniBtn.Text = "-"
miniBtn.Font = Enum.Font.GothamBold
miniBtn.TextSize = 18
miniBtn.BackgroundTransparency = 1
miniBtn.TextColor3 = Color3.new(1,1,1)

local TweenService = game:GetService("TweenService")
local minimized = false
miniBtn.MouseButton1Click:Connect(function()
    minimized = not minimized
    statusLabel.Visible = not minimized
    for _,btn in ipairs(buttons) do btn.Visible = not minimized end
    local targetSize = minimized and UDim2.new(0,260,0,30) or UDim2.new(0,260,0,30+35+#buttons*40)
    TweenService:Create(frame, TweenInfo.new(0.25, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {Size = targetSize}):Play()
end)

-- Rainbow Background (optional)
task.spawn(function()
    local hue = 0
    while task.wait(0.03) do
        hue = (hue + 0.002) % 1
        frame.BackgroundColor3 = Color3.fromHSV(hue, 0.6, 0.15)
        for _,btn in ipairs(buttons) do
            btn.BackgroundColor3 = Color3.fromHSV(hue, 0.7, 0.3)
        end
    end
end)

-- ======== VARIABLES & REMOTES ========
local RS = game:GetService("ReplicatedStorage")
local WS = game:GetService("Workspace")
local lplr = player

-- ensure events exist safely
local function safeEvent(path)
    local ok, obj = pcall(function() return RS:WaitForChild("Package",5).Events:FindFirstChild(path) end)
    if ok and obj then return obj end
    return nil
end

local hakaiRemote = safeEvent("Hak")
local punchRemote = safeEvent("p")
-- other events used inline will be waited for in functions (mel, voleys, equipskill, ta, cha, block)

local attacks2 = {
    "High Power Rush","Spirit Breaking Cannon","Spirit Barrage","Meteor Crash",
    "Super Dragon Fist","Mach Kick","God Slicer","Wolf Fang Fist","Flash Kick",
    "Vanish Strike","Bone Crusher","Uppercut","Rock Impact","Sledgehammer",
    "Vital Strike","Meteor Strike","Meteor Charge"
}

-- Global toggles
getgenv().AutoTransform = false
getgenv().AutoFarmBroccoli = false
getgenv().AutoBlock = false
getgenv().AutoCharge = false
getgenv().FlyPatch = false
getgenv().AutoQuestFarm = false

-- Running guards for loops
local BroccoliLoopRunning = false
local QuestFarmRunning = false
local TransformLoopRunning = false
local ChargeLoopRunning = false
local BlockLoopRunning = false
local FlyPatchLoopRunning = false

-- Helper to update status label
local function updateStatus()
    local parts = {}
    if getgenv().AutoTransform then table.insert(parts, "Transform ON") end
    if getgenv().AutoFarmBroccoli then table.insert(parts, "Farm ON") end
    if getgenv().AutoBlock then table.insert(parts, "Block ON") end
    if getgenv().AutoCharge then table.insert(parts, "Charge ON") end
    if getgenv().FlyPatch then table.insert(parts, "Fly ON") end
    if getgenv().AutoQuestFarm then table.insert(parts, "Quest ON") end
    statusLabel.Text = "Status: " .. (#parts > 0 and table.concat(parts, " | ") or "All OFF")
end

-- ================= TRANSFORM =================
-- ================= TRANSFORM =================
local function form()
    pcall(function()
        local equipskill = RS:WaitForChild("Package",5).Events:WaitForChild("equipskill")
        local ta = RS:WaitForChild("Package",5).Events:WaitForChild("ta")
        local formName = "Beast"
        equipskill:InvokeServer(formName)
        repeat task.wait()
            if player.Status and player.Status.SelectedTransformation and player.Status.Transformation then
                if player.Status.SelectedTransformation.Value ~= player.Status.Transformation.Value then
                    ta:InvokeServer()
                end
            else
                break
            end
        until player.Status.SelectedTransformation.Value == player.Status.Transformation.Value
    end)
end

-- Auto-transform loop (safe single loop)
task.spawn(function()
    while true do
        task.wait(1)
        if getgenv().AutoTransform then
            form()
        end
    end
end)

-- ================= CHARGE (cha) =================
local function doCharge()
    pcall(function()
        local events = RS:WaitForChild("Package",5).Events
        local cha = events:FindFirstChild("cha")
        if cha then
            local args = {[1] = "Blacknwhite27"}
            cha:InvokeServer(unpack(args))
        end
    end)
end

task.spawn(function()
    if ChargeLoopRunning then return end
    ChargeLoopRunning = true
    while true do
        task.wait()
        if getgenv().AutoCharge then
            doCharge()
        end
    end
end)

-- ================= BLOCK =================
local function doBlock()
    pcall(function()
        local events = RS:WaitForChild("Package",5).Events
        local block = events:FindFirstChild("block")
        if block and lplr.Status and lplr.Status.Blocking then
            if lplr.Status.Blocking.Value ~= true then
                pcall(function()
                    block:InvokeServer(true)
                end)
            end
        end
    end)
end

task.spawn(function()
    if BlockLoopRunning then return end
    BlockLoopRunning = true
    while true do
        task.wait()
        if getgenv().AutoBlock then
            doBlock()
        end
    end
end)

-- ================= FLY PATCH (BodyVelocity/BodyGyro) =================
local function applyFlyPatch()
    pcall(function()
        local localPlayer = player
        if not WS:FindFirstChild("Living") then return end
        local playerModel = WS.Living:FindFirstChild(localPlayer.Name)
        if not playerModel then return end
        local humanoidRootPart = playerModel:FindFirstChild("HumanoidRootPart")
        if not humanoidRootPart then return end
        local bv = humanoidRootPart:FindFirstChild("BodyVelocity")
        local bg = humanoidRootPart:FindFirstChild("BodyGyro")
        if bv and bg then
            bg.P = 1
            bg.MaxTorque = Vector3.new(500000, 500000, 500000)
            bv.P = 1
            bv.MaxForce = Vector3.new(100000, 100000, 100000)
        end
    end)
end

task.spawn(function()
    if FlyPatchLoopRunning then return end
    FlyPatchLoopRunning = true
    while true do
        task.wait()
        if getgenv().FlyPatch then
            applyFlyPatch()
        end
    end
end)

-- anti-idle
local bb= game:service'VirtualUser'
game:service'Players'.LocalPlayer.Idled:connect(function()
    bb:CaptureController()bb:ClickButton2(Vector2.new())
end)

-- ================= FARM BROCCOLI =================
local function farmBroccoliLoop()
    if BroccoliLoopRunning then return end
    BroccoliLoopRunning = true
    task.spawn(function()
        while true do
            task.wait(0.2)
            if not getgenv().AutoFarmBroccoli then
                task.wait(0.5)
            else
                pcall(function()
                    local character = player.Character
                    if not character or not character:FindFirstChild("HumanoidRootPart") or not WS:FindFirstChild("Living") then
                        return
                    end

                    local living = WS:FindFirstChild("Living")
                    local boss = living:FindFirstChild("Broccoli")
                    if boss and boss:FindFirstChild("Humanoid") and boss:FindFirstChild("HumanoidRootPart") and boss.Humanoid.Health > 0 then
                        -- approach loop
                        local approach = task.spawn(function()
                            repeat
                                task.wait()
                                if not getgenv().AutoFarmBroccoli then break end
                                pcall(function()
                                    character.HumanoidRootPart.CFrame = boss.HumanoidRootPart.CFrame * CFrame.new(0, 0, 3)
                                end)
                            until not boss or not boss.Parent or boss.Humanoid.Health <= 0 or not character or not character.Parent or character.Humanoid.Health <= 0 or not getgenv().AutoFarmBroccoli
                        end)

                        -- attack spam waves
                        repeat
                            task.wait(0.1)
                            if not getgenv().AutoFarmBroccoli then break end
                            local A_3 = "Blacknwhite27"
                            local spam = 0
                            repeat
                                task.wait(0.1)
                                if not getgenv().AutoFarmBroccoli then break end
                                task.spawn(function()
                                    for _, A_1 in ipairs(attacks2) do
                                        task.spawn(function()
                                            pcall(function()
                                                local events = RS:WaitForChild("Package",5).Events
                                                local mel = events:FindFirstChild("mel")
                                                if mel then
                                                    mel:InvokeServer(A_1, A_3)
                                                end
                                                if hakaiRemote and boss and boss:FindFirstChild("HumanoidRootPart") then
                                                    hakaiRemote:InvokeServer('Soul Punisher','["MouseHit"] = '.. tostring(boss.HumanoidRootPart.CFrame) ..',["FaceMouse"] = false','Blacknwhite27')
                                                end
                                                local voleys = events:FindFirstChild("voleys")
                                                if voleys and boss and boss:FindFirstChild("HumanoidRootPart") then
                                                    local args = {[1] = "Energy Volley", [2] = {["MouseHit"] = boss.HumanoidRootPart.CFrame, ["FaceMouse"] = false}, [3] = A_3}
                                                    voleys:InvokeServer(unpack(args))
                                                end
                                                if punchRemote then
                                                    for i = 1, 6 do
                                                        pcall(function()
                                                            punchRemote:FireServer(A_3, i)
                                                        end)
                                                    end
                                                end
                                            end)
                                        end)
                                    end
                                end)
                                spam = spam + 1
                            until spam == 10 or not getgenv().AutoFarmBroccoli or not boss or boss.Humanoid.Health <= 0 or not character or character.Humanoid.Health <= 0
                        until not boss or boss.Humanoid.Health <= 0 or not player.Character or player.Character.Humanoid.Health <= 0 or not getgenv().AutoFarmBroccoli
                    end
                end)
            end
        end
    end)
end

-- ================= AUTO QUEST / GRIND (Quest Grind toggle) =================
local SelectedQuests = ""
local SelectedMobs = ""
local checkValue = 0

local function autoquest()
    pcall(function()
        local data = RS:WaitForChild("Datas")[player.UserId]
        local a = data.Strength.Value
        local b = data.Energy.Value
        local c = data.Defense.Value
        local d = data.Speed.Value

        local minimo = math.min(a, b, c, d)
        checkValue = minimo

        for _, v in ipairs(WS:WaitForChild("Living"):GetChildren()) do
            if minimo <= 100000000 then
                if v:FindFirstChild("Humanoid") and v.Humanoid.Health > 0 and v.Name == "Mapa" then
                    SelectedQuests = v.Name
                    SelectedMobs = v.Name
                    return
                end
            else
                if v:FindFirstChild("Humanoid") and v.Humanoid.Health > 0 and v.Name == "Broccoli" then
                    SelectedQuests = v.Name
                    SelectedMobs = v.Name
                    return
                end
            end
        end
    end)
end

local function quest()
    pcall(function()
        local npc = WS:FindFirstChild("Others") and WS.Others:FindFirstChild("NPCs") and WS.Others.NPCs:FindFirstChild(SelectedQuests)
        if not npc then return end

        local plrData = RS:FindFirstChild("Datas") and RS.Datas:FindFirstChild(tostring(player.UserId))
        if plrData and plrData:FindFirstChild("Quest") and plrData.Quest.Value ~= SelectedQuests then
            if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
                player.Character.HumanoidRootPart.CFrame = npc.HumanoidRootPart.CFrame
                repeat
                    task.wait()
                    RS.Package.Events.Qaction:InvokeServer(npc)
                until (plrData.Quest.Value == SelectedQuests) or (player.Character and player.Character.Humanoid and player.Character.Humanoid.Health <= 0)
            end
        end
    end)
end

local function startQuestFarm()
    if QuestFarmRunning then return end
    QuestFarmRunning = true
    task.spawn(function()
        while getgenv().AutoQuestFarm do
            pcall(function()
                autoquest()
                for _, v in ipairs(WS:WaitForChild("Living"):GetChildren()) do
                    if SelectedMobs ~= "" and v.Name:lower() == SelectedMobs:lower()and player.Character and player.Character:FindFirstChild("HumanoidRootPart") and v:FindFirstChild("Humanoid") and v:FindFirstChild("HumanoidRootPart") and v.Humanoid.Health > 0 then
                        quest()
                        -- Positioning
                        local posThread = task.spawn(function()
                            repeat
                                if not getgenv().AutoQuestFarm then break end
                                if player.Character and player.Character:FindFirstChild("HumanoidRootPart") and v and v:FindFirstChild("HumanoidRootPart") then
                                    pcall(function()
                                        player.Character.HumanoidRootPart.CFrame = v.HumanoidRootPart.CFrame * CFrame.new(0,0,3)
                                    end)
                                end
                                task.wait()
                            until not v or not v.Parent or v.Humanoid.Health <= 0 or not player.Character or (player.Character.Humanoid and player.Character.Humanoid.Health <= 0)
                        end)

                        -- Attacking logic
                        repeat
                            task.wait(0.1)
                            if not getgenv().AutoQuestFarm then break end
                            local canUseKi = false
                            pcall(function()
                                if WS:FindFirstChild("Living") and WS.Living:FindFirstChild(player.Name) and WS.Living[player.Name].Stats and WS.Living[player.Name].Stats.Ki then
                                    canUseKi = WS.Living[player.Name].Stats.Ki.Value > 10000
                                end
                            end)

                            if checkValue > 2100000 and canUseKi then
                                -- move spam
                                for _, A_1 in ipairs(attacks2) do
                                    task.spawn(function()
                                        pcall(function()
                                            local events = RS:WaitForChild("Package",5).Events
                                            if events:FindFirstChild("letsplayagame") then
                                                events.letsplayagame:InvokeServer(A_1, "Blacknwhite27")
                                            end
                                            if events:FindFirstChild("Haha") then
                                                events.Haha:InvokeServer(A_1, "Blacknwhite27")
                                            end
                                            if hakaiRemote and v and v:FindFirstChild("HumanoidRootPart") then
                                                hakaiRemote:InvokeServer('Soul Punisher','["MouseHit"] = '.. tostring(v.HumanoidRootPart.CFrame) ..',["FaceMouse"] = false','Blacknwhite27')
                                            end
                                        end)
                                    end)
                                end
                            else
                                -- punches
                                for i=1,6 do
                                    pcall(function()
                                        if punchRemote then
                                            punchRemote:FireServer('Blacknwhite27', i)
                                        end
                                    end)
                                end
                            end
                        until not v or not v.Parent or v.Humanoid.Health <= 0 or not player.Character or (player.Character.Humanoid and player.Character.Humanoid.Health <= 0) or not getgenv().AutoQuestFarm
                    end
                end
            end)
            task.wait()
        end
        QuestFarmRunning = false
    end)
end

-- Buttons wiring to toggles and UI update
local function toggleBtnState(btn, flagName)
    getgenv()[flagName] = not getgenv()[flagName]
    -- update button text (simple replace OFF/ON)
    if btn.Text:find("OFF") then
        btn.Text = btn.Text:gsub("OFF","ON")
    else
        btn.Text = btn.Text:gsub("ON","OFF")
    end
    updateStatus()
end

transformBtn.MouseButton1Click:Connect(function()
    toggleBtnState(transformBtn, "AutoTransform")
end)

farmBtn.MouseButton1Click:Connect(function()
    toggleBtnState(farmBtn, "AutoFarmBroccoli")
    if getgenv().AutoFarmBroccoli then
        farmBroccoliLoop()
    end
end)

blockBtn.MouseButton1Click:Connect(function()
    toggleBtnState(blockBtn, "AutoBlock")
end)

chargeBtn.MouseButton1Click:Connect(function()
    toggleBtnState(chargeBtn, "AutoCharge")
end)

flyBtn.MouseButton1Click:Connect(function()
    toggleBtnState(flyBtn, "FlyPatch")
end)

questBtn.MouseButton1Click:Connect(function()
    toggleBtnState(questBtn, "AutoQuestFarm")
    if getgenv().AutoQuestFarm then
        startQuestFarm()
    end
end)

-- Final initial status update
updateStatus()

-- Safety print
print("[BroccoliFarmUI] Loaded. Use the UI toggles to enable features.")
